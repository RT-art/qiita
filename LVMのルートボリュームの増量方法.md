# 【備忘録】Hyper-V上のOracle Linuxでルートボリュームが枯渇！LVMでオンライン拡張する手順

## はじめに

こんにちは！
先日、実務でHyper-V上のOracle LinuxにPostgreSQLのリストアをしていたところ、ルートボリュームのディスク容量が枯渇するという事態に見舞われました 😱
今回は、その際に実施した**ルートボリュームのオンライン拡張手順**を備忘録としてまとめます。

Linuxを触り始めたばかりの方や、LVMでのディスク拡張が初めての方の参考になれば幸いです。

### 執筆時の環境

  * **仮想化環境**: Hyper-V
  * **OS**: Oracle Linux
  * **ボリューム管理**: LVM

-----

## 前提知識のクイックレビュー

手順に入る前に、今回の作業で登場する重要な概念を簡単におさらいします。

### ディスクとパーティション

Linuxでは、ハードウェアはすべてファイルとして扱われ、`/dev`ディレクトリにまとめられています。

  * `/dev/sda`: 1台目のストレージデバイス（ハードディスクやSSD）全体を表します。
  * `/dev/sda1`, `/dev/sda2`: `/dev/sda`を分割した個々の領域（パーティション）です。

### パーティションテーブル (GPT vs MBR)

パーティションの情報を管理する形式には、主に2つの種類があります。

  * **MBR (Master Boot Record)**: 古くから使われている形式。最大2TBまでのディスク、最大4つのプライマリパーティションという制限があります。
  * **GPT (GUID Partition Table)**: 新しい形式。事実上、容量やパーティション数の制限はありません。

自分のディスクがどちらの形式か確認するには、以下のコマンドを実行します。
出力の `Disklabel type:` の部分が `dos` ならMBR、`gpt` ならGPTです。

```bash
sudo fdisk -l /dev/sda
```

### ファイルシステム

パーティションで区切っただけでは、まだデータを保存することはできません。
**ファイルシステム**を作成（フォーマット）することで、初めてファイルの保存や管理ができるようになります。

ファイルシステムは、データの保存場所を管理したり（アドレッシング）、ファイル名やサイズといったメタデータを保持したりする「ルール」のようなものです。

  * **主なファイルシステムの種類**
      * `ext4`: Linuxの標準的なファイルシステム。
      * `xfs`: 大規模なファイルシステムや高いパフォーマンスが求められる場面で使われます。
      * `btrfs`: スナップショットやコピーオンライトなど、多機能で新しいファイルシステム。

### LVM (Logical Volume Manager)

LVMは、複数の物理的なディスクやパーティションをまとめて、一つの大きな仮想的なディスク（**ボリュームグループ**）として扱えるようにする仕組みです。そして、その仮想ディスクを必要なサイズに切り出して（**論理ボリューム**）、OSに提供します。

  * **PV (Physical Volume / 物理ボリューム)**: `/dev/sda4` のような物理パーティションのこと。LVMの管理下に置かれたもの。
  * **VG (Volume Group / ボリュームグループ)**: 複数のPVをまとめたグループ。
  * **LV (Logical Volume / 論理ボリューム)**: VGから切り出して作成される、OSが実際にマウントして使用する領域。

今回の環境では、`/dev/mapper/ol-root` という名前が使われていました。これは、

  * `ol`: Oracle Linuxのインストーラーがデフォルトで作成した**ボリュームグループ (VG)**
  * `root`: そのVG内に作られた、ルートファイルシステム `/` 用の**論理ボリューム (LV)**

を意味しています。`/dev/mapper/` は、このLVMの仕組み（Device Mapper）によって作られた論理ボリュームであることを示しています。

-----

## ルートボリュームのオンライン拡張手順

それでは、実際にルートボリュームを拡張していきます。OSを停止させる必要のない**オンライン**での拡張手順です。

### Step 1: Hyper-Vで仮想ディスクを拡張する

まず、仮想マシンが使用している仮想ハードディスク（.vhdx）のサイズを大きくします。

1.  対象の仮想マシンをシャットダウンします。
2.  Hyper-Vマネージャーで、仮想マシンの「設定」を開きます。
3.  「ハードウェア」から「SCSIコントローラー」\>「ハードドライブ」を選択します。
4.  仮想ハードディスクの「編集」ボタンをクリックします。
5.  ウィザードが起動したら、「拡張」を選択し、希望のサイズ（今回は64GBから100GBへ）に変更します。
6.  完了後、仮想マシンを起動します。

### Step 2: OS側でディスクの認識状況を確認する

OSを起動したら、SSHなどでログインし、ディスクの状況を確認します。

```bash
sudo lsblk
```

`sda`のサイズがHyper-Vで設定した100GBになっている一方で、パーティション（`sda1`, `sda2`, `sda3`）の合計が元のサイズのままであることが確認できます。ここに新しいパーティションを追加していきます。

### Step 3: 新しいパーティションを作成する (`fdisk`)

`fdisk`コマンドを使い、ディスクの空き領域に新しいパーティションを作成します。

```bash
sudo fdisk /dev/sda
```

`fdisk`の対話モードが起動したら、以下の順でコマンドを入力していきます。

1.  `n` を入力してEnter（新しいパーティションを作成）
2.  `p` を入力してEnter（プライマリパーティションを選択）
3.  パーティション番号を `4` にしてEnter（sda1,2,3があるので次は4）
4.  First sector, Last sector はそのままEnter（自動で最大サイズが選択される）
5.  `t` を入力してEnter（パーティションのタイプを変更）
6.  パーティション番号を `4` にしてEnter
7.  Hex code (L to list all codes) に `31` を入力してEnter（`Linux LVM` のタイプコード）
8.  `w` を入力してEnter（変更内容をディスクに書き込んで終了）

これで、`/dev/sda4` というLVM用のパーティションが作成されました。

### Step 4: 物理ボリューム (PV) を作成する (`pvcreate`)

次に、作成したパーティション `/dev/sda4` をLVMが管理できる「物理ボリューム(PV)」に変換します。

```bash
sudo pvcreate /dev/sda4
```

`Physical volume "/dev/sda4" successfully created` と表示されれば成功です。

### Step 5: ボリュームグループ (VG) を拡張する (`vgextend`)

新しく作成したPV (`/dev/sda4`) を、既存のボリュームグループ `ol` に追加して、VG全体のサイズを大きくします。

```bash
sudo vgextend ol /dev/sda4
```

`Volume group "ol" successfully extended` と表示されれば成功です。

> **Tips:** 自分のボリュームグループ(VG)名は `vgdisplay` コマンドで確認できます。

### Step 6: 論理ボリューム (LV) を拡張する (`lvextend`)

ボリュームグループが大きくなったので、その増えた分の領域をルート用の論理ボリューム `/dev/mapper/ol-root` に割り当てます。

```bash
# VG内の全ての空き容量をLVに割り当てる
sudo lvextend -l +100%FREE /dev/mapper/ol-root
```

`-l +100%FREE` は、「ボリュームグループ内の空き領域を100%すべて割り当てる」という意味の便利なオプションです。

### Step 7: ファイルシステムを拡張する

最後に、論理ボリュームのサイズに合わせてファイルシステムのサイズも拡張します。これにより、OSが拡張されたディスク領域を実際に認識できるようになります。

使用しているファイルシステムによってコマンドが異なります。`df -Th` などで確認しましょう。

  * **ext4 の場合:**

    ```bash
    sudo resize2fs /dev/mapper/ol-root
    ```

  * **xfs の場合:**

    ```bash
    sudo xfs_growfs /
    ```

コマンドを実行すると、自動的にファイルシステムが拡張されます。

### Step 8: 最終確認

`df -h` コマンドを実行して、ルート (`/`) のサイズが増えていることを確認しましょう！

```bash
df -h
```

`Size` の項目が100GB近くになっていれば、すべての作業は完了です。お疲れ様でした！

## まとめ

今回は、Hyper-V上のOracle LinuxでLVMを利用してルートボリュームをオンラインで拡張する手順をまとめました。

1.  **Hyper-V** で仮想ディスクのサイズを拡張
2.  **`fdisk`** で空き領域に新しいパーティションを作成 (Type: Linux LVM)
3.  **`pvcreate`** でパーティションを物理ボリューム (PV) に変換
4.  **`vgextend`** で既存のボリュームグループ (VG) にPVを追加
5.  **`lvextend`** で論理ボリューム (LV) を拡張
6.  **`resize2fs` / `xfs_growfs`** でファイルシステムを拡張

LVMを使っていると、このようにOSを止めずに柔軟なディスク管理ができるので非常に便利ですね。
この記事が誰かのお役に立てれば嬉しいです。